---
title: HTML渲染之重绘重排
nav:
  title: 基础沉淀
  path: /article
group:
  path: /browser
  title: 浏览器
  order: 2
order: 3
---

# HTML 渲染之重绘重排

## 什么是重绘重排

### 重排（回流）

当 DOM 的变化影响了元素的几何信息(元素的的位置和尺寸大小)，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫做`重排(回流)`。这个修改会让浏览器从布局开始更新整个渲染流水线，这个开销是最大的。

#### 触发条件

回流这一阶段主要是计算节点的位置和几何信息，当页面布局和几何信息发生变化的时候，会导致`重排reflow`。

- 一个 DOM 元素的几何属性变化，常见的几何属性有 width、height、padding、margin、left、top、border 等等。
- 使 DOM 节点发生增减或者移动。
- 读写 offset 家族、scroll 家族和 client 家族属性的时候，浏览器为了获取这些值，需要进行回流操作。
- 调用 window.getComputedStyle 方法。

### 重绘

当一个元素的外观发生改变，但没有改变布局,重新把元素外观绘制出来的过程，叫做`重绘`。在重绘阶段，系统会遍历渲染树，并调用渲染对象的 `paint` 方法，将渲染对象的内容显示在屏幕上。相较于重排操作，重绘省去了布局阶段，所以执行效率会比重排操作要高一些。

#### 触发条件

重绘是一个元素外观的改变所触发的浏览器行为，例如改变 `visibility`、`outline`、`background-color` 等属性，这些属性只是影响元素的外观，风格，并且没有影响几何属性的时候，会导致`重绘repaint`。

**`重排`必定会发生`重绘`，`重绘`不一定会引发`重排`**。

## 像素管道

浏览器运行的单个帧的渲染流水线，称为像素管道。一个经典的图：

<img src="./image/pxPie.png"/>

- `JavaScript` 一般来说，我们会使用 JavaScript 来实现一些视觉变化的效果。比如用 jQuery 的 animate 函数做一个动画、对一个数据集进行排序或者往页面里添加一些 DOM 元素等。当然，除了 JavaScript，还有其他一些常用方法也可以实现视觉变化效果，比如：CSS Animations、Transitions 和 Web Animation API。

- `Style` 此过程就是利用 CSS 匹配器计算出元素的变化，再进行计算每个元素的最终样式。

- `Layout` 当 Style 规则应用后，浏览器会开始计算其在屏幕上显示的位置和占据的空间大小，然而一个元素的变动可能会影响到另外一个元素，从而引起重排，所以布局变动是很频繁的，这一过程经常发生。

- `Paint` 绘制就是简单的像素填充，会将排列好的样式进行填充。其包括文本、颜色、图片、边框、阴影等任何可视部分。因为网页样式是个层级结构，所以绘制操作会在每一层进行。

- `Composite` 因为层级原因，当层级绘制完成，为了确保层级结构的正确，合成操作会按照正确的层级顺序绘制到屏幕上，以便保证渲染的正确性，因为一个小小的层级顺序错误，就有可能造成样式紊乱。

管道的每个部分都有可能会产生卡顿，所以我们务必要知道哪一部分出现了问题，对症下药。

由于现在浏览器的更新，许多浏览器已经能够将绘制样式变动和页面绘制分开线程进行渲染，这已经不是我们能够控制的了，但是无论怎么变动，管道始终要进行，不一定每帧都总是会经过管道每个部分的处理。实际上，不管是使用 JavaScript、CSS 还是网络动画，在实现视觉变化时，管道针对指定帧的运行通常有三种方式。

### 管道运行方式

**JS/CSS —> Style —> Layout —> Paint —> Composite**

此过程就是我们常说的浏览器重排，也就是改变了元素的几何属性（例如宽度、高度、左侧或顶部位置等），那么浏览器将必须检查所有其他元素，然后“自动重排”页面。任何受影响的部分都需要重新绘制，而且最终绘制的元素需进行合成，重排进行了管道的每一步，性能受到较大影响。

**JS/CSS —> Style —> Paint —> Composite**

这既是我们常说的重绘，也就是修改“paint only”属性（例如背景图片、文字颜色或阴影等），即不会影响页面布局的属性，则浏览器会跳过布局，但仍将执行绘制。

**JS/CSS —> Style —> Composite**

此过程不会重排重绘，仅仅是进行合成，也就是修改 transform 和 opacity 属性更改来实现动画，性能得到较大提升，最适合于应用生命周期中的高压力点，例如动画或滚动。
